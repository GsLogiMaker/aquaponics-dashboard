<html>

	<head>

		<style>
			textarea {
				resize: none;
				width: 100%;
    			box-sizing: border-box;
			}
			#hcontainer > div
			{
				display: inline-block;
			}
		</style>

		<script>

			setInterval(process, 3000);
			process()

			function process() {
				fetch("/state")
					.then((response) => response.json())
					.then((data) => {
					document.getElementById("humidity_label")
						.innerHTML = data.humidity;

					// Update buttons
					document.getElementById("system_toggle")
						.checked = data.is_system_on;
					document.getElementById("led_toggle")
						.checked = data.is_led_on;
					document.getElementById("pump_toggle")
						.checked = data.is_pump_on;
					
					// Update message log
					if (data.is_new_message) {
						fetch("/message")
							.then((response) => response.text())
							.then((data) => {
								document.getElementById("msg_log")
									.innerHTML = data;
							})
					}
					});
			}

			function post(to) {
				let response = fetch(to, {method: 'POST'});
				let result = response.json();
				alert(result.answer);
			}

			function _on_system_toggled(checkbox) {
				if (checkbox.checked) {
					post("/system_on");
				} else {
					post("/system_off");
				}
			}

			function _on_led_toggled(checkbox) {
				if (checkbox.checked) {
					post("/led_on");
				} else {
					post("/led_off");
				}
			}


			function _on_pump_toggled(checkbox) {
				if (checkbox.checked) {
					post("/pump_on");
				} else {
					post("/pump_off");
				}
			}

		</script>

	</head>

	<body>

		<h1>Aquaponics System Control</h1>

		<h4>Message Log</h4>
		<textarea id="msg_log" name="msg_log" rows="8" cols="100" readonly>
		</textarea>
		
		<div id="hcontainer">
			<div><h4>Humidity</h4></div>
			<div id="humidity_label">-</div>
		</div>

		<!-- SYSTEM -->
		<div id="hcontainer">
			<div><h4>System</h4></div>
			<div id="hcontainer">
				<div>
					<input id="system_toggle" type="checkbox" name="system_toggle" onclick="_on_system_toggled(this)">
				</div>
			</div>
		</div>

		<!-- LED -->
		<div id="hcontainer">
			<div><h4>LED</h4></div>
			<div id="hcontainer">
				<div>
					<input id="led_toggle" type="checkbox" name="led_toggle" onclick="_on_led_toggled(this)">
				</div>
			</div>
		</div>

		<!-- PUMP -->
		<div id="hcontainer">
			<div><h4>Pump</h4></div>
			<div id="hcontainer">
				<div>
					<input id="pump_toggle" type="checkbox" name="pump_toggle" onclick="_on_pump_toggled(this)">
				</div>
			</div>
		</div>

	</body> 

</html>